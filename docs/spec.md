# PORTERS リストアップロード仕様書

## 概要
本プログラムは、PORTERSシステムから「求職者情報」と「選考プロセス情報」という2種類のデータを取得し、所定のGoogleスプレッドシートへ転記するツールです。  
ログイン認証は、IDとパスワードのみを利用し、二段階認証等の特別な方式は採用しません。  
取得したCSVファイルのフォーマットやデータ変換、整形処理は行わず、ダウンロードしたデータをそのまま転記します。  
「別シートに集計・転記」部分の詳細な仕様は、後日追加の指示に基づいて更新します。

## 処理フローの詳細

### 1. PORTERSへのログイン処理
- 環境変数からPORTERSのログイン情報（会社ID、ユーザー名、パスワード）を取得
- Seleniumを利用してPORTERSのログインページにアクセス
- ログイン情報を入力し、ログインボタンをクリック
- 二重ログインポップアップが表示された場合は、OKボタンをクリックして処理を継続
- ログイン成功後、ページ内容を解析して正常にログインできたことを確認

### 2. 求職者情報の取得と転記
#### 2.1 求職者一覧画面への遷移
- 「その他業務」ボタンをクリックして新しいウィンドウを開く
- メニュー項目5をクリック
- 「すべての求職者」リンクをクリック
- 求職者一覧画面が表示されることを確認

#### 2.2 求職者データの全件表示
- 「全てチェック」チェックボックスをクリックして全ての求職者を選択
- 「もっと見る」ボタンを繰り返しクリックし、すべての求職者データを表示
  - ボタンが見つからなくなるまで、5秒間隔で最大20回クリックを試行
  - 動的に変わるセレクタに対応するため、クラス名やテキスト内容で要素を特定

#### 2.3 CSVダウンロードと転記
- アクション一覧ボタンをクリック
- エクスポートボタンをクリック
- エクスポートモーダルで「候補者リスト（全rawデータ）」を選択
- 「次へ」ボタンをクリック（1/3）
- 「次へ」ボタンをクリック（2/3）
- 「実行」ボタンをクリック（3/3）
- OKボタンをクリック
- エクスポート処理の完了を30秒間待機
- エクスポート結果一覧ボタンをクリック
  - 最大3回、30秒間隔でリトライ
- CSVダウンロードリンクをクリック
  - 最大3回、30秒間隔でリトライ
- ダウンロードしたCSVファイルの内容を、所定のGoogleスプレッドシートに転記
  - CSVのフォーマット変更やデータの整形処理は行わない
- 取得した求職者情報について、別シートに集計・転記処理を実施
  - 詳細な集計内容は後日指示

### 3. 選考プロセス情報の取得と転記
#### 3.1 選考プロセス一覧画面への遷移
- 「その他業務」ボタンをクリックして新しいウィンドウを開く
- メニュー項目5をクリック
- 「選考プロセス」リンクをクリック
- 選考プロセス一覧画面が表示されることを確認

#### 3.2 選考プロセスデータの全件表示
- 「全てチェック」チェックボックスをクリックして全ての選考プロセスを選択
- 「もっと見る」ボタンを繰り返しクリックし、すべての選考プロセスデータを表示
  - ボタンが見つからなくなるまで、5秒間隔で最大20回クリックを試行
  - 動的に変わるセレクタに対応するため、クラス名やテキスト内容で要素を特定

#### 3.3 CSVダウンロードと転記
- アクション一覧ボタンをクリック
- エクスポートボタンをクリック
- エクスポートモーダルで適切なデータ形式を選択
- 「次へ」ボタンをクリック（1/3）
- 「次へ」ボタンをクリック（2/3）
- 「実行」ボタンをクリック（3/3）
- OKボタンをクリック
- エクスポート処理の完了を30秒間待機
- エクスポート結果一覧ボタンをクリック
  - 最大3回、30秒間隔でリトライ
- CSVダウンロードリンクをクリック
  - 最大3回、30秒間隔でリトライ
- ダウンロードしたCSVファイルの内容を、所定のGoogleスプレッドシートに転記
  - CSVのフォーマット変更やデータの整形処理は行わない
- 取得した選考プロセス情報について、別シートに集計・転記処理を実施
  - 詳細な集計内容は後日指示

### 4. 終了処理
- PORTERSからログアウト
- ブラウザを終了
- 処理結果のサマリーをログに出力

## 技術的実装詳細

### セレクタ管理
- セレクタ情報は `config/selectors.csv` で一元管理
- セレクタ情報には、グループ名、要素名、セレクタタイプ、セレクタ値、説明を含む
- 動的に変わる要素に対しては、複数の検索方法（セレクタ、クラス名、テキスト内容）を実装

### ブラウザ操作
- ブラウザ操作は `PortersBrowser` クラスのメソッドを使用
- 要素のクリックは `click_element` メソッドを使用し、通常のクリックとJavaScriptクリックの両方を試行
- 新しいウィンドウへの切り替えは `switch_to_new_window` メソッドを使用

### エラー処理
- 各操作ステップでエラーが発生した場合、詳細なエラーメッセージをログに記録
- スクリーンショットとHTMLソースを保存し、エラー状況の詳細な分析を可能に
- 可能な限り代替手段（JavaScriptでのクリック、テキスト内容での要素検索など）を試行

### ログ管理
- エラー発生時の詳細なエラーメッセージおよびログ出力は、 `src/utils/logging_config.py` に定義された設定に準拠して実施
- ログ管理は、タイムローテーション付きファイル出力とコンソール出力を併用し、適切に管理
- 重要な操作の前後でスクリーンショットを取得し、処理の流れを視覚的に確認可能

### CSVエクスポート処理
- エクスポート処理は `export_candidates_data` メソッドで実装
- 各ステップ（アクション一覧ボタンのクリック、エクスポートボタンのクリックなど）で複数の検索方法を試行
- ダウンロード完了を待機するため、十分な時間（10秒）を設定
- 各ステップでスクリーンショットを取得し、処理の流れを視覚的に確認可能

### CSVダウンロード処理
- ダウンロード処理は `_download_exported_csv` メソッドで実装
- エクスポート結果一覧ボタンのクリックとCSVダウンロードリンクのクリックに対して、最大3回のリトライ機能を実装
- リトライ間隔は30秒に設定し、処理の安定性を確保
- 各リトライ時にスクリーンショットを取得し、エラー状況の詳細な分析を可能に

## 実行オプション
- `--headless`: ブラウザを表示せずにヘッドレスモードで実行
- `--env [development|production]`: 実行環境を指定
- `--skip-operations`: 業務操作をスキップし、ログイン処理のみを実行

## 備考
- 本仕様に基づいて実装を進め、必要となる変更や追加の仕様（例：「別シートに集計・転記」処理の詳細）は、チーム内で合意の上、随時更新する。
- スプレッドシートは必ずGoogle Spreadsheetを利用し、PORTERSシステムとの連携部分は適切なAPIや自動化ツールを用いて実装する。

## 技術仕様
- 本システムは、ブラウザの自動操作にSeleniumを利用して実装する。
- DOM要素のセレクタ管理は、`/config/selectors.csv`を利用して汎用的かつ柔軟な対象指定を実現する。
