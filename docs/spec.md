# 相談フラグ管理システム 仕様書

## 概要

本システムは、特定の条件（フラグ）に一致するIDを検索し、それらのIDを相談転記先リストに更新するためのツールです。Google Spreadsheetを使用してデータを管理し、自動的に条件に合致するIDを抽出して転記先リストを更新します。さらに、抽出したIDのユーザー情報をCSVファイルとして保存し、PORTERSシステムにインポートする機能も備えています。

## 処理フローの概要

1. **相談フラグの確認と新規IDの抽出**
   - 相談フラグマスタ（M_相談フラグ）からフラグが1に設定されている項目を抽出
   - 現在の仕様では、「オンライン相談中」「LINE相談中」「求人紹介（電話）」などが相談フラグとして設定
   - 友達リストDLデータシートの"対応マーク"列を確認し、抽出したフラグ項目に一致するIDを特定
   - 既存の相談転記先リストに存在しないIDを新規IDとして抽出

2. **相談転記先リストの更新**
   - 抽出した新規IDと相談日（現在の日付）を相談転記先リスト（相談Raw）に追加
   - 同時にログシート（相談者一覧）にもIDを転記

3. **アンケートデータの取得とCSV出力**
   - 新しく追加されたIDのユーザーのアンケートDLデータからレコードを取得
   - 取得したレコードをCSVファイルとして保存（cp932エンコーディング）

4. **PORTERSへのデータインポート**
   - Seleniumを使用してPORTERSシステムにログイン
   - 求職者インポート機能を使用
   - 保存したCSVファイルをアップロード
   - LINE初回アンケート取込形式でインポート

## 詳細処理フロー

### 1. 相談フラグの確認と新規IDの抽出（src/main.py）

1. **環境設定の読み込み**
   - 環境変数とシート設定を読み込む

2. **スプレッドシートへの接続**
   - Google Sheets APIを使用してスプレッドシートに接続

3. **相談フラグマスタの読み込み**
   - M_相談フラグシートからデータを取得
   - フラグ列が1に設定されている項目を抽出

4. **友達リストの読み込み**
   - 友達リストDLデータシートからデータを取得
   - "対応マーク"列の値を確認し、抽出したフラグ項目に一致するIDを特定

5. **既存の相談転記先リストとの比較**
   - 相談転記先リスト（相談Raw）からデータを取得
   - 既に登録されているIDを除外し、新規IDのみを抽出

6. **相談転記先リストの更新**
   - 新規IDと相談日（現在の日付）を相談転記先リストに追加
   - 同時にログシート（相談者一覧）にもIDを転記

### 2. アンケートデータの取得とCSV出力（tests/test_anq_data_analysis.py）

1. **環境設定の読み込み**
   - 環境変数とシート設定を読み込む

2. **スプレッドシートへの接続**
   - Google Sheets APIを使用してスプレッドシートに接続
   - settings シートからシート名マッピングを取得

3. **アンケートDLデータシートの読み込み**
   - アンケートDLデータシートからヘッダー行を取得
   - 指定されたIDのレコードを検索

4. **データの加工と保存**
   - 取得したデータをDataFrameに変換
   - CSVファイルとして保存（cp932エンコーディング）

### 3. PORTERSへのデータインポート（tests/test_main.py, test_login.py, test_browser.py, test_csv_import.py）

1. **ブラウザの初期化**
   - Seleniumを使用してChromeブラウザを起動
   - セレクタ情報の読み込み

2. **PORTERSへのログイン**
   - 環境変数からログイン情報を取得
   - ログインページにアクセス
   - 会社ID、ユーザー名、パスワードを入力してログイン
   - 二重ログインポップアップの処理

3. **求職者インポート機能へのアクセス**
   - メニューから「求職者のインポート」リンクを探索してクリック
   - ポップアップの表示を確認

4. **CSVファイルのアップロード**
   - 「添付」ボタンをクリック
   - CSVファイルを選択
   - 「LINE初回アンケート取込」形式を選択
   - 「次へ」ボタンをクリック

5. **インポート設定と実行**
   - インポート設定画面での必要な設定を行う
   - インポート処理を実行
   - 完了確認

6. **ログアウト**
   - 明示的なログアウト処理を実行
   - ブラウザを終了

## システム構成

### 主要コンポーネント

1. **メインモジュール** (`src/main.py`)
   - システム全体の実行を制御
   - 相談フラグの確認と新規IDの抽出、相談転記先リストの更新を担当

2. **アンケートデータ分析モジュール** (`tests/test_anq_data_analysis.py`)
   - 新規IDのアンケートデータを取得
   - CSVファイルとして保存

3. **PORTERSインポートモジュール**
   - `tests/test_main.py`: インポート処理全体の制御
   - `tests/test_login.py`: PORTERSへのログイン処理
   - `tests/test_browser.py`: ブラウザ操作の基本機能
   - `tests/test_csv_import.py`: CSVファイルのインポート処理

4. **フラグ検索モジュール** (`src/modules/consult_flags.py`)
   - 相談フラグマスタから条件に一致するIDを検索

5. **転記リスト更新モジュール** (`src/modules/transfer_list.py`)
   - 検索されたIDを相談転記先リストに更新

6. **設定管理モジュール** (`src/modules/settings.py`)
   - スプレッドシートの設定情報を管理

7. **スプレッドシート接続モジュール** (`src/modules/spreadsheet.py`)
   - Google Spreadsheetへの接続と基本操作を提供

8. **ユーティリティモジュール**
   - 環境変数管理 (`src/utils/environment.py`)
   - ログ設定 (`src/utils/logging_config.py`)

### データソース

- **Google Spreadsheet**
  - 友達リストDLデータ: ユーザー情報を格納
  - アンケートDLデータ: アンケート回答データを格納
  - 相談フラグマスタ: 相談条件のフラグを管理
  - 相談転記先リスト: 条件に一致したIDの転記先
  - settings: シート名のマッピング情報を管理

## 詳細仕様

### 1. メインモジュール (`src/main.py`)

#### 処理フロー

1. **環境変数のロード**
   - `env.load_env()` を呼び出して環境変数と設定ファイルを読み込む
   - 設定ファイル（.env, settings.ini）から必要な情報を取得

2. **フラグに一致するIDの検索**
   - `find_ids_with_matching_flags()` 関数を呼び出す
   - 相談フラグマスタから条件に一致するIDのリストを取得

3. **検索結果の処理**
   - IDが見つかった場合:
     - 見つかったIDの数と一覧を表示
     - 相談転記先リストの更新処理を実行
   - IDが見つからなかった場合:
     - エラーメッセージを表示
     - ログを確認するよう促す

4. **相談転記先リストの更新**
   - `update_consult_transfer_list(matching_ids)` 関数を呼び出す
   - 見つかったIDを相談転記先リストに追加/更新
   - 更新結果を表示

#### エラー処理

- 各処理段階でエラーが発生した場合は適切なメッセージを表示
- ログファイルに詳細なエラー情報を記録

### 2. スプレッドシート接続モジュール (`src/modules/spreadsheet.py`)

#### `get_spreadsheet_connection()`

**目的**: Google Spreadsheetへの接続を確立し、スプレッドシートオブジェクトを返す

**処理ステップ**:
1. 設定ファイルからスプレッドシートIDを取得
2. サービスアカウントファイルのパスを取得
3. Google API認証用のスコープを設定
   - `https://spreadsheets.google.com/feeds`
   - `https://www.googleapis.com/auth/drive`
4. サービスアカウントの認証情報を取得
5. gspreadクライアントを作成して認証
6. スプレッドシートをIDで開く
7. 接続したスプレッドシートオブジェクトを返す

**エラー処理**:
- 接続エラーが発生した場合はログに記録し、`None`を返す

#### `get_column_index(headers, column_name)`

**目的**: ヘッダー行から特定の列名のインデックスを取得する

**入力**:
- `headers`: ヘッダー行のリスト
- `column_name`: 検索する列名

**処理ステップ**:
1. ヘッダー行リストから指定された列名のインデックスを検索
2. 見つかった場合はそのインデックスを返す

**エラー処理**:
- 列名が見つからない場合はエラーをログに記録し、`None`を返す

### 3. 設定管理モジュール (`src/modules/settings.py`)

#### `load_sheet_settings(spreadsheet)`

**目的**: settingsシートから各シート名マッピングを読み込む

**入力**:
- `spreadsheet`: スプレッドシートオブジェクト

**処理ステップ**:
1. settings.iniから以下のキー名を取得
   - 友達リストDLデータ (`FRIEND_DATA`)
   - 相談フラグマスタ (`CONSULT_FLAG_MASTER`)
   - 相談転記先リスト (`CONSULT_TRANSFER_LIST`)
2. スプレッドシートから'settings'シートを取得
3. settingsシートのデータを取得し、キーと値のマッピングを作成
4. 各キーに対応する実際のシート名を取得
   - 友達データシート名
   - 相談フラグマスタシート名
   - 相談転記先リストシート名
5. 取得したシート名をタプルで返す

**エラー処理**:
- settingsシートが見つからない場合はエラーをログに記録
- 必要なキーが見つからない場合はエラーをログに記録
- エラー発生時は `None, None, None` を返す

### 4. フラグ検索モジュール (`src/modules/consult_flags.py`)

#### `find_ids_with_matching_flags()`

**目的**: フラグに一致するIDを検索して返す

**処理ステップ**:
1. **スプレッドシートへの接続**
   - `get_spreadsheet_connection()` を呼び出してスプレッドシートに接続
   - 接続に失敗した場合は `None` を返す

2. **シート設定の読み込み**
   - `load_sheet_settings(spreadsheet)` を呼び出して各シートの実際の名前を取得
   - 友達シート名、相談フラグマスタシート名、転記先シート名を取得
   - 設定の読み込みに失敗した場合は `None` を返す

3. **相談フラグマスタシートからデータ取得**
   - 相談フラグマスタシートを取得
   - シートからすべての値を取得
   - ヘッダー行を取得（1行目）

4. **「項目」と「フラグ」列のインデックス取得**
   - `get_column_index()` を使用して「項目」と「フラグ」列のインデックスを取得
   - インデックスが取得できない場合は `None` を返す

5. **フラグが1の項目を抽出**
   - 相談フラグマスタの各行をループ
   - 「フラグ」列の値が "1" の行の「項目」列の値を抽出
   - フラグが1の項目リストを作成

6. **友達リストDLデータシートからデータ取得**
   - 友達リストDLデータシートを取得
   - シートからすべての値を取得
   - ヘッダー行を取得（2行目を使用）

7. **「ID」と「対応マーク」列のインデックス取得**
   - `get_column_index()` を使用して「ID」と「対応マーク」列のインデックスを取得
   - インデックスが取得できない場合は `None` を返す

8. **対応マークとフラグ項目を比較して一致するIDを抽出**
   - 友達リストの各行をループ（3行目から開始）
   - 「対応マーク」列の値がフラグ付き項目のいずれかを含むか確認
   - 一致する場合は「ID」列の値を結果リストに追加
   - 一致するIDのリストを作成

9. **結果の返却**
   - 一致するIDのリストを返す

**エラー処理**:
- シートが見つからない場合はエラーをログに記録し、`None`を返す
- データ処理中にエラーが発生した場合はエラーをログに記録し、`None`を返す

### 5. 転記リスト更新モジュール (`src/modules/transfer_list.py`)

#### `update_consult_transfer_list(matching_ids)`

**目的**: 相談転記先リストにマッチしたIDを追加する

**入力**:
- `matching_ids`: 追加するIDのリスト

**処理ステップ**:
1. **スプレッドシートへの接続**
   - `get_spreadsheet_connection()` を呼び出してスプレッドシートに接続
   - 接続に失敗した場合は `False` を返す

2. **シート設定の読み込み**
   - `load_sheet_settings(spreadsheet)` を呼び出して各シートの実際の名前を取得
   - 特に相談転記先リストシート名を取得
   - 設定の読み込みに失敗した場合は `False` を返す

3. **相談転記先リストシートからデータ取得**
   - 相談転記先リストシートを取得
   - シートからすべての値を取得
   - ヘッダー行を取得（1行目）

4. **IDと相談日のカラムインデックスを特定**
   - ヘッダー行から「ID」と「相談日」列のインデックスを取得
   - インデックスが取得できない場合は `False` を返す

5. **既存のIDを取得**
   - 相談転記先リストの各行をループ（2行目から開始）
   - 「ID」列の値を整数に変換して既存IDリストに追加
   - 数値に変換できないIDはスキップ

6. **追加すべきIDを特定**
   - 入力された `matching_ids` の各IDをループ
   - IDを整数に変換
   - 既存IDリストに含まれていないIDを追加すべきIDリストに追加
   - 数値に変換できないIDはスキップ

7. **追加すべきIDがない場合の処理**
   - 追加すべきIDがない場合は処理を終了し、`True` を返す

8. **今日の日付を取得**
   - 現在の日付を「YYYY/MM/DD」形式で取得

9. **新しい行を作成**
   - 追加すべき各IDについて新しい行を作成
   - 「ID」列にIDを設定
   - 「相談日」列に今日の日付を設定

10. **スプレッドシートに追加**
    - 追加開始行を計算（既存データの最終行の次）
    - A1形式のレンジを構築
    - 新しい行をスプレッドシートに追加

11. **ログシートへの転記**
    - ログ用スプレッドシートIDを取得
    - ログ用スプレッドシートに接続
    - 「相談者一覧」シートを取得
    - A列の最終行を取得
    - 追加すべきIDをA列に追加

12. **結果の返却**
    - 処理が成功した場合は `True` を返す

**エラー処理**:
- シートが見つからない場合はエラーをログに記録し、`False`を返す
- データ処理中にエラーが発生した場合はエラーをログに記録し、`False`を返す
- ログシートへの転記中にエラーが発生した場合はエラーをログに記録するが、メイン処理は継続

## 処理フロー図
[main.py]
|
├── 環境変数のロード (env.load_env())
|
├── フラグに一致するIDの検索 (find_ids_with_matching_flags())
| |
| ├── [spreadsheet.py] スプレッドシートに接続 (get_spreadsheet_connection())
| |
| ├── [settings.py] シート設定を読み込む (load_sheet_settings())
| |
| ├── 相談フラグマスタからデータ取得
| |
| ├── フラグが1の項目を抽出
| |
| ├── 友達リストからデータ取得
| |
| └── 対応マークとフラグ項目を比較して一致するIDを抽出
|
└── 相談転記先リストの更新 (update_consult_transfer_list())
|
├── [spreadsheet.py] スプレッドシートに接続 (get_spreadsheet_connection())
|
├── [settings.py] シート設定を読み込む (load_sheet_settings())
|
├── 相談転記先リストからデータ取得
|
├── 既存のIDと追加すべきIDを特定
|
├── 新しい行を作成して追加
|
└── ログシートにも転記

## 実行方法
bash
環境設定
python -m pip install -r requirements.txt
実行
python -m src.main

## エラー処理

- 各処理段階でエラーが発生した場合はログに詳細を記録
- 処理の成功/失敗を明確に表示し、失敗時はログを確認するよう促す
- 接続エラーやデータ不整合などの一般的なエラーに対応

## 拡張機能

### アンケートデータ分析 (`tests/test_anq_data_analysis.py`)

- **機能**: アンケートDLデータから特定のIDのレコードを取得し分析
- **処理内容**:
  1. Google Spreadsheetに接続
  2. アンケートDLデータシートを取得
  3. 指定されたIDのレコードを検索
  4. 取得したデータをCSVファイルとして保存（cp932エンコーディング）
- **実行方法**: `python -m tests.test_anq_data_analysis`
