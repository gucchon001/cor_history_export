# PORTERS リストアップロード仕様書

## 概要
本プログラムは、PORTERSシステムから「求職者情報」と「選考プロセス情報」という2種類のデータを取得し、所定のGoogleスプレッドシートへ転記するツールです。  
ログイン認証は、IDとパスワードのみを利用し、二段階認証等の特別な方式は採用しません。  
取得したCSVファイルのフォーマットやデータ変換、整形処理は行わず、ダウンロードしたデータをそのまま転記します。  
また、求職者データのフェーズ別集計と選考プロセスデータの日次集計処理を実施し、それぞれ別シートに集計結果を出力します。

## 処理フローの詳細

### 1. PORTERSへのログイン処理
- 環境変数からPORTERSのログイン情報（会社ID、ユーザー名、パスワード）を取得
- Seleniumを利用してPORTERSのログインページにアクセス
- ログイン情報を入力し、ログインボタンをクリック
- 二重ログインポップアップが表示された場合は、OKボタンをクリックして処理を継続
- ログイン成功後、ページ内容を解析して正常にログインできたことを確認

### 2. 求職者情報の取得と転記
#### 2.1 求職者一覧画面への遷移
- 「その他業務」ボタンをクリックして新しいウィンドウを開く
- メニュー項目5をクリック
- 「すべての求職者」リンクをクリック
- 求職者一覧画面が表示されることを確認

#### 2.2 求職者データの全件表示
- 「全てチェック」チェックボックスをクリックして全ての求職者を選択
- 「もっと見る」ボタンを繰り返しクリックし、すべての求職者データを表示
  - ボタンが見つからなくなるまで、5秒間隔で最大20回クリックを試行
  - 動的に変わるセレクタに対応するため、クラス名やテキスト内容で要素を特定

#### 2.3 CSVダウンロードと転記
- アクション一覧ボタンをクリック
- エクスポートボタンをクリック
- エクスポートモーダルで「候補者リスト（全rawデータ）」を選択
- 「次へ」ボタンをクリック（1/3）
- 「次へ」ボタンをクリック（2/3）
- 「実行」ボタンをクリック（3/3）
- OKボタンをクリック
- エクスポート処理の完了を30秒間待機
- エクスポート結果一覧ボタンをクリック
  - 最大3回、30秒間隔でリトライ
- CSVダウンロードリンクをクリック
  - 最大3回、30秒間隔でリトライ
- ダウンロードしたCSVファイルの内容を、所定のGoogleスプレッドシートに転記
  - CSVのフォーマット変更やデータの整形処理は行わない

#### 2.4 求職者データの集計処理
- 取得した求職者データからフェーズごとの人数をカウント
- 集計対象のフェーズ：
  - 相談前×推薦前(新規エントリー)
  - 相談前×推薦前(open)
  - 推薦済(仮エントリー)
  - 面談設定済
  - 終了
- 集計結果をCOUNT_USERSシートに記録
  - 現在の日付と共に新しい行として追加
  - 集計日付とフェーズごとの人数を出力

### 3. 選考プロセス情報の取得と転記
#### 3.1 選考プロセス一覧画面への遷移
- 「その他業務」ボタンをクリックして新しいウィンドウを開く
- メニュー項目5をクリック
- 「選考プロセス」リンクをクリック
- 選考プロセス一覧画面が表示されることを確認

#### 3.2 選考プロセスデータの全件表示
- 「全てチェック」チェックボックスをクリックして全ての選考プロセスを選択
- 「もっと見る」ボタンを繰り返しクリックし、すべての選考プロセスデータを表示
  - ボタンが見つからなくなるまで、5秒間隔で最大20回クリックを試行
  - 動的に変わるセレクタに対応するため、クラス名やテキスト内容で要素を特定

#### 3.3 CSVダウンロードと転記
- アクション一覧ボタンをクリック
- エクスポートボタンをクリック
- エクスポートモーダルで適切なデータ形式を選択
- 「次へ」ボタンをクリック（1/3）
- 「次へ」ボタンをクリック（2/3）
- 「実行」ボタンをクリック（3/3）
- OKボタンをクリック
- エクスポート処理の完了を30秒間待機
- エクスポート結果一覧ボタンをクリック
  - 最大3回、30秒間隔でリトライ
- CSVダウンロードリンクをクリック
  - 最大3回、30秒間隔でリトライ
- ダウンロードしたCSVファイルの内容を、所定のGoogleスプレッドシートに転記
  - CSVのフォーマット変更やデータの整形処理は行わない

#### 3.4 選考プロセスデータの集計処理
- 取得した選考プロセスデータを日付ごとにまとめる
- 集計する項目：
  - 求職者ID
  - 性名/名前
  - 企業コード
  - 企業名
  - 選考プロセス
  - 担当CA
- 集計結果をLIST_ENTRYPROCESSシートに記録
  - 新しい選考プロセスエントリを識別し追加
  - 日付ごとにソートして表示

### 4. 終了処理
- PORTERSからログアウト
- ブラウザを終了
- 処理結果のサマリーをログに出力

## 技術的実装詳細

### セレクタ管理
- セレクタ情報は `config/selectors.csv` で一元管理
- セレクタ情報には、グループ名、要素名、セレクタタイプ、セレクタ値、説明を含む
- 動的に変わる要素に対しては、複数の検索方法（セレクタ、クラス名、テキスト内容）を実装

### ブラウザ操作
- ブラウザ操作は `PortersBrowser` クラスのメソッドを使用
- 要素のクリックは `click_element` メソッドを使用し、通常のクリックとJavaScriptクリックの両方を試行
- 新しいウィンドウへの切り替えは `switch_to_new_window` メソッドを使用

### エラー処理
- 各操作ステップでエラーが発生した場合、詳細なエラーメッセージをログに記録
- スクリーンショットとHTMLソースを保存し、エラー状況の詳細な分析を可能に
- 可能な限り代替手段（JavaScriptでのクリック、テキスト内容での要素検索など）を試行

### ログ管理
- エラー発生時の詳細なエラーメッセージおよびログ出力は、 `src/utils/logging_config.py` に定義された設定に準拠して実施
- ログ管理は、タイムローテーション付きファイル出力とコンソール出力を併用し、適切に管理
- 重要な操作の前後でスクリーンショットを取得し、処理の流れを視覚的に確認可能

### CSVエクスポート処理
- エクスポート処理は `export_candidates_data` メソッドで実装
- 各ステップ（アクション一覧ボタンのクリック、エクスポートボタンのクリックなど）で複数の検索方法を試行
- ダウンロード完了を待機するため、十分な時間（10秒）を設定
- 各ステップでスクリーンショットを取得し、処理の流れを視覚的に確認可能

### CSVダウンロード処理
- ダウンロード処理は `_download_exported_csv` メソッドで実装
- エクスポート結果一覧ボタンのクリックとCSVダウンロードリンクのクリックに対して、最大3回のリトライ機能を実装
- リトライ間隔は30秒に設定し、処理の安定性を確保
- 各リトライ時にスクリーンショットを取得し、エラー状況の詳細な分析を可能に

### スプレッドシート集計処理
- 集計処理は `SpreadsheetAggregator` クラスで実装
- 求職者データの集計は `aggregate_users_by_phase` メソッドで実装
- 選考プロセスデータの集計は `aggregate_entry_process` メソッドで実装
- スプレッドシートの管理は `SpreadsheetManager` クラスを使用し、シートごとのデータアクセスを抽象化

## 実行オプション
- `--process`: 処理フローを指定
  - `candidates`: 求職者一覧のみエクスポート（デフォルト）
  - `entryprocess`: 選考プロセス一覧のみエクスポート
  - `both`: 両方を順に実行（別々のセッションで処理）
  - `sequential`: 求職者一覧取得後に選考プロセスも取得（同一セッションで連続処理）
- `--aggregate`: 集計処理を指定
  - `none`: 集計処理を実行しない（デフォルト）
  - `users`: 求職者フェーズ別集計のみ実行
  - `entryprocess`: 選考プロセス集計のみ実行
  - `both`: 両方の集計処理を実行
- `--headless`: ブラウザを表示せずにヘッドレスモードで実行
- `--env [development|production]`: 実行環境を指定
- `--skip-operations`: 業務操作をスキップし、ログイン処理のみを実行
- `--log-level [DEBUG|INFO|WARNING|ERROR|CRITICAL]`: ログレベルを指定

## 実行方法

### コマンドライン実行
```bash
# 基本実行（求職者一覧のみ取得）
python -m src.main

# 求職者一覧と選考プロセスの両方を取得
python -m src.main --process both

# データ取得と集計を一度に行う
python -m src.main --process sequential --aggregate both

# 集計処理のみを実行
python -m src.aggregate_spreadsheet --aggregation-type both
```

### バッチファイル実行
```bash
# 開発環境での実行（デフォルトで求職者一覧のみ取得）
run_dev.bat

# 本番環境での実行（すべての処理を実行）
run.bat
```

## 備考
- 本仕様に基づいて実装されたシステムは、ブラウザの自動操作とデータ集計の両方に対応しており、定期的なデータ取得と分析を効率化します。
- スプレッドシートはGoogle Spreadsheetを利用し、適切なAPIを通じてデータの読み書きを行います。
- システムはWindows環境での実行を前提として設計されています。

## 技術仕様
- Python 3.8以上が必要です。
- ブラウザの自動操作にはSeleniumを使用します。
- スプレッドシートの操作にはGoogle Sheets APIを使用します。
- 設定ファイルは以下の3種類を使用します：
  - `config/settings.ini`: シート名やURLなどの設定
  - `config/secrets.env`: PORTERSログイン情報やAPI認証情報
  - `config/selectors.csv`: ブラウザ操作に使用するHTML要素のセレクタ定義
